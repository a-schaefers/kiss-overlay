#!/bin/sh -e

#HACK

wget https://dl.suckless.org/sinit/sinit-1.0.tar.gz
echo "78c2120a97a5e93b80606c5403bd731152f8a344e47aa4ab74970c1c11dc6fc0" sinit-1.0.tar.gz | sha256sum -c -
tar zxvf sinit-1.0.tar.gz
cat << EOF > sinit-1.0/config.h
static char *const rcinitcmd[]     = { "/boot/boot.el", NULL };
static char *const rcrebootcmd[]   = { "/boot/boot.el", "reboot", NULL };
static char *const rcpoweroffcmd[] = { "/boot/boot.el", "poweroff", NULL };
EOF
cd sinit-1.0
make CFLAGS="$CFLAGS -static"
install -Dm 755 sinit "$1/boot/sinit"
cd ..
./configure \
    --prefix=/boot/emacs \
    --with-modules \
    --without-all \
    --without-x \
    --with-x-toolkit=no \
    --with-x=no

make
make DESTDIR="$1" install

install -Dm 755 dummy.boot.el "$1/boot/dummy.boot.el"
